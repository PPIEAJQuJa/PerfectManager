<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espace Manager</title>
    <style>
        /* Styles CSS inchangés */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }

        .navbar {
            background-color: #ff6600;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .navbar .logo {
            font-size: 18px;
            font-weight: bold;
        }

        .navbar .nav-links {
            display: flex;
            gap: 15px;
        }

        .navbar .nav-links a {
            color: white;
            text-decoration: none;
            font-size: 14px;
        }

        .navbar .nav-links a:hover {
            text-decoration: underline;
        }

        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f5f5f5;
        }

        .form-wrapper {
            width: 100%;
            max-width: 800px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px 30px;
        }

        .form-wrapper h1 {
            text-align: center;
            font-size: 24px;
            margin-bottom: 20px;
            color: #ff6600;
        }

        .button {
            padding: 12px 20px;
            font-size: 16px;
            background-color: #ff6600;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .button:hover {
            background-color: #e65c00;
        }

        .secondary {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
        }

        .secondary a {
            color: #ff6600;
            text-decoration: none;
        }

        .secondary a:hover {
            text-decoration: underline;
        }

        .company-info {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #ff6600;
            color: white;
            border-radius: 5px;
        }

        .company-info h2 {
            margin: 0;
        }

        .table-wrapper {
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th, table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        table th {
            background-color: #f4f4f4;
            font-weight: bold;
        }

        .charges-summary {
            margin-top: 20px;
            padding: 10px;
            background-color: #f4f4f4;
            border-radius: 5px;
        }

        /* Style du formulaire d'achat */
        .buy-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .buy-modal .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            width: 300px;
        }

        .buy-modal .modal-content input {
            padding: 8px;
            margin: 10px 0;
            width: 100%;
        }

        .buy-modal .modal-content button {
            padding: 10px;
            background-color: #ff6600;
            color: white;
            border: none;
            cursor: pointer;
            width: 100%;
        }

        .buy-modal .modal-content button:hover {
            background-color: #e65c00;
        }

        /* Style du formulaire d'ajout de produit */
        .add-product-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .add-product-modal .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            width: 300px;
        }

        .add-product-modal .modal-content input {
            padding: 8px;
            margin: 10px 0;
            width: 100%;
        }

        .add-product-modal .modal-content button {
            padding: 10px;
            background-color: #ff6600;
            color: white;
            border: none;
            cursor: pointer;
            width: 100%;
        }

        .add-product-modal .modal-content button:hover {
            background-color: #e65c00;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="logo">
            <img src="Logo.png" alt="Logo du jeu" style="height: 40px;"> <!-- Ajustez la hauteur selon vos besoins -->
        </div>
        <div class="nav-links">
            <a href="Nous contacter.html">Nous contacter</a>
            <a href="Regles du jeu.html">Règles du jeu</a>
        </div>
    </div>

    <div class="container">
        <div class="form-wrapper">
            <h1>Votre Espace Manager</h1>

            <!-- Informations de l'entreprise -->
            <div class="company-info">
                <h2><span id="company-name">Chargement...</span></h2>
                <p>Capital Restant : <span id="remaining-capital">Chargement...</span></p>
                <p>Investissements Achetés : <span id="bought-investments">Chargement...</span></p>
                <p>Investissements Loués : <span id="rented-investments">Chargement...</span></p>
            </div>

            <!-- Section pour afficher les stocks de marchandises -->
            <div class="table-wrapper">
                <h2>Stocks de Marchandises</h2>
                <table id="stock-table">
                    <thead>
                        <tr>
                            <th>Produit</th>
                            <th>Quantité Disponible</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Les stocks seront ajoutés ici dynamiquement -->
                    </tbody>
                </table>
            </div>

            <!-- Somme des charges par saison -->
            <div class="charges-summary">
                <h3>Charges par Saison :</h3>
                <p id="charges-per-season">Chargement...</p>
            </div>

            <!-- Boutons pour terminer la saison ou le jeu -->
            <div style="display: flex; gap: 10px;">
                <button id="end-season-button">Terminer la saison</button>
                <button id="end-game-button">Terminer le jeu</button>
            </div>

            <!-- Tableau des Offres du Marché -->
            <div class="table-wrapper">
                <h2>Offres du Marché</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Désignation</th>
                            <th>Quantité</th>
                            <th>Prix Unitaire</th>
                            <th>Montant</th>
                            <th>Vendeur</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="product-list">
                        <!-- Les produits seront ajoutés ici dynamiquement -->
                    </tbody>
                </table>
            </div>

            <div class="secondary">
                <a href="#" id="add-product-button">Ajouter un produit</a>
            </div>

            <!-- Tableau de l'historique des transactions -->
            <div class="table-wrapper">
                <h2>Historique des Transactions</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Désignation</th>
                            <th>Entreprise Vendeuse</th>
                            <th>Quantité</th>
                            <th>Prix de la transaction</th>
                            <th>Montant de la transaction</th>
                            <th>Nature de la transaction</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-history">
                        <!-- Les transactions seront ajoutées ici dynamiquement -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Boîte de dialogue d'achat -->
    <div id="buy-modal" class="buy-modal">
        <div class="modal-content">
            <h3>Acheter un produit</h3>
            <p id="product-name">Nom du produit</p>
            <p>Prix Unitaire: <span id="product-price">0</span> Booster</p>
            <p>Vendeur: <span id="product-seller">Grand Marché</span></p>
            <label for="quantity">Quantité :</label>
            <input type="number" id="quantity" min="1" placeholder="Quantité à acheter">
            <button id="buy-button">Acheter</button>
            <button onclick="closeModal()">Fermer</button>
        </div>
    </div>

    <!-- Boîte de dialogue d'ajout de produit -->
    <div id="add-product-modal" class="add-product-modal">
        <div class="modal-content">
            <h3>Ajouter un produit</h3>
            <label for="product-name-input">Nom du produit :</label>
            <input type="text" id="product-name-input" placeholder="Nom du produit">
            <label for="product-quantity-input">Quantité :</label>
            <input type="number" id="product-quantity-input" placeholder="Quantité">
            <label for="product-price-input">Prix unitaire :</label>
            <input type="number" id="product-price-input" placeholder="Prix unitaire">
            <button id="add-product-button-modal">Ajouter</button>
            <button onclick="closeAddProductModal()">Fermer</button>
        </div>
    </div>

    <script>
        // Récupérer les données enregistrées depuis localStorage
        const savedData = JSON.parse(localStorage.getItem('companyData'));

        // Variables pour gérer les stocks de marchandises
        let stocks = savedData?.stocks || []; // Stocks de l'entreprise

        // Offres du Marché (démarre avec un seul produit)
        let marketOffers = [
            { name: "Marchandises", quantity: 2000, unitPrice: 100, seller: "Grand Marché" }
        ];

        let transactionHistory = []; // Tableau pour l'historique des transactions
        let companyCapital = savedData ? savedData.capital : 50000; // Capital initial de l'entreprise
        let seasonCharges = savedData ? savedData.totalCharges : 5000; // Charges par saison initiales

        // Afficher les données de l'entreprise
        if (savedData) {
            document.getElementById('company-name').textContent = savedData.name;
            document.getElementById('remaining-capital').textContent = `${companyCapital.toLocaleString()} Booster`;
            document.getElementById('charges-per-season').textContent = `${seasonCharges.toLocaleString()} Booster`;

            // Filtrer les investissements achetés et loués
            const boughtInvestments = savedData.investments.filter(inv => inv.type === "Achat").map(inv => inv.item).join(", ");
            const rentedInvestments = savedData.investments.filter(inv => inv.type === "Location").map(inv => inv.item).join(", ");

            document.getElementById('bought-investments').textContent = boughtInvestments || "Aucun";
            document.getElementById('rented-investments').textContent = rentedInvestments || "Aucun";
        } else {
            document.getElementById('company-name').textContent = "Aucune donnée trouvée";
        }

        // Fonction pour afficher les stocks de marchandises
        function displayStocks() {
            const stockTable = document.getElementById("stock-table").querySelector("tbody");
            stockTable.innerHTML = "";

            stocks.forEach(stock => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${stock.name}</td>
                    <td>${stock.quantity}</td>
                `;
                stockTable.appendChild(row);
            });
        }

        // Fonction pour afficher les offres du marché
        function displayMarketOffers() {
            const productList = document.getElementById("product-list");
            productList.innerHTML = "";

            marketOffers.forEach(offer => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${offer.name}</td>
                    <td>${offer.quantity}</td>
                    <td>${offer.unitPrice} Booster</td>
                    <td>${offer.unitPrice * offer.quantity} Booster</td>
                    <td>${offer.seller}</td>
                    <td><button onclick="openBuyModal('${offer.name}', ${offer.unitPrice}, '${offer.seller}')">Acheter</button></td>
                `;
                productList.appendChild(row);
            });
        }

        // Fonction pour afficher l'historique des transactions
        function displayTransactionHistory() {
            const transactionTable = document.getElementById("transaction-history");
            transactionTable.innerHTML = "";

            transactionHistory.forEach(transaction => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${transaction.name}</td>
                    <td>${transaction.seller}</td>
                    <td>${transaction.quantity}</td>
                    <td>${transaction.unitPrice} Booster</td>
                    <td>${transaction.totalPrice} Booster</td>
                    <td>${transaction.type}</td>
                `;
                transactionTable.appendChild(row);
            });
        }

        // Fonction pour acheter un produit
        document.getElementById("buy-button").onclick = () => {
            const quantity = parseInt(document.getElementById("quantity").value);
            const productName = document.getElementById("product-name").textContent;
            const productPrice = parseFloat(document.getElementById("product-price").textContent);
            const seller = document.getElementById("product-seller").textContent;

            const offer = marketOffers.find(offer => offer.name === productName && offer.seller === seller);

            if (quantity > 0 && quantity <= offer.quantity) {
                const totalPrice = quantity * productPrice;

                if (totalPrice > companyCapital) {
                    showNotification("Capital insuffisant pour effectuer cet achat.");
                    return;
                }

                // Mettre à jour les stocks de l'entreprise
                const stockIndex = stocks.findIndex(stock => stock.name === productName);
                if (stockIndex !== -1) {
                    stocks[stockIndex].quantity += quantity; // Ajouter la quantité achetée au stock
                } else {
                    stocks.push({ name: productName, quantity: quantity }); // Ajouter un nouveau stock
                }

                // Mettre à jour l'offre du marché
                offer.quantity -= quantity;
                if (offer.quantity === 0) {
                    marketOffers = marketOffers.filter(o => o !== offer); // Supprimer l'offre si la quantité est épuisée
                }

                // Mettre à jour les données
                companyCapital -= totalPrice;

                transactionHistory.push({
                    name: productName,
                    seller: seller,
                    quantity: quantity,
                    unitPrice: productPrice,
                    totalPrice: totalPrice,
                    type: "Achat",
                });

                // Mettre à jour l'affichage
                displayStocks();
                displayMarketOffers();
                displayTransactionHistory();
                document.getElementById("remaining-capital").textContent = `${companyCapital.toLocaleString()} Booster`;
                showNotification("Achat réussi.", true);
                closeModal();
            } else if (quantity > offer.quantity) {
                showNotification("Quantité demandée trop élevée. Transaction refusée.");
            } else {
                showNotification("Veuillez entrer une quantité valide.");
            }
        };

        // Fonction pour ouvrir la boîte de dialogue d'achat
        function openBuyModal(name, price, seller) {
            document.getElementById("buy-modal").style.display = "flex";
            document.getElementById("product-name").textContent = name;
            document.getElementById("product-price").textContent = price;
            document.getElementById("product-seller").textContent = seller;
        }

        // Fonction pour fermer la boîte de dialogue d'achat
        function closeModal() {
            document.getElementById("buy-modal").style.display = "none";
        }

        // Fonction pour ajouter un produit
        document.getElementById("add-product-button").onclick = () => {
            document.getElementById("add-product-modal").style.display = "flex";
        };

        document.getElementById("add-product-button-modal").onclick = () => {
            const name = document.getElementById("product-name-input").value;
            const quantity = parseInt(document.getElementById("product-quantity-input").value);
            const price = parseFloat(document.getElementById("product-price-input").value);

            if (name && quantity && price) {
                // Vérifier si le produit existe déjà dans les stocks
                const stockIndex = stocks.findIndex(stock => stock.name === name);
                if (stockIndex !== -1 && stocks[stockIndex].quantity >= quantity) {
                    // Ajouter l'offre au marché
                    marketOffers.push({ name, quantity, unitPrice: price, seller: savedData.name });
                    stocks[stockIndex].quantity -= quantity; // Réduire le stock
                    displayMarketOffers();
                    displayStocks();
                    closeAddProductModal();
                } else {
                    alert("Stock insuffisant pour ajouter ce produit.");
                }
            } else {
                alert("Veuillez remplir tous les champs.");
            }
        };

        // Fermer la boîte de dialogue d'ajout de produit
        function closeAddProductModal() {
            document.getElementById("add-product-modal").style.display = "none";
        }

        // Fonction pour terminer la saison
        document.getElementById("end-season-button").onclick = () => {
            companyCapital -= seasonCharges;
            transactionHistory.push({
                name: "Paiement des charges / saison",
                seller: "N/A",
                quantity: 1,
                unitPrice: seasonCharges,
                totalPrice: seasonCharges,
                type: "Dépense",
            });

            document.getElementById("remaining-capital").textContent = `${companyCapital.toLocaleString()} Booster`;
            displayTransactionHistory();
            showNotification("Saison terminée. Charges déduites.");
        };

        // Fonction pour terminer le jeu
        document.getElementById("end-game-button").onclick = () => {
            // Sauvegarder les données de l'entreprise pour la page "Résultat"
            const resultData = {
                companyName: savedData.name,
                finalCapital: companyCapital,
                totalCharges: seasonCharges,
                investments: savedData.investments,
                transactionHistory: transactionHistory,
                stocks: stocks // Sauvegarder les stocks
            };

            localStorage.setItem('gameResultData', JSON.stringify(resultData));

            // Rediriger vers la page "Résultat.html"
            window.location.href = "Resultat.html";
        };

        // Initialisation
        displayStocks();
        displayMarketOffers();
        displayTransactionHistory();
    </script>
</body>
</html>